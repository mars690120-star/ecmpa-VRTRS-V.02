<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç–«è‹—å†°ç®±æº«åº¦ç›£æ§è¨˜éŒ„è¡¨</title>
    
    <!-- 1. å¼•å…¥å¿…è¦çš„å‡½å¼åº« (ä½¿ç”¨ç©©å®šç‰ˆ CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- æ ¸å¿ƒæ¨£å¼å€ --- */

        /* è®“æœˆä»½é¸æ“‡å™¨æ¸¸æ¨™è®Šç‚ºæ‰‹æŒ‡ï¼Œæç¤ºå¯é»æ“Š */
        input[type="month"], select { cursor: pointer; }
        
        /* è¼¸å…¥æ¡†é€šç”¨æ¨£å¼ */
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 4px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
        }
        input:focus, select:focus {
            outline: 2px solid #3b82f6;
            border-color: transparent;
        }

        /* Modal (åˆ—å°é¸å–®) æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (@media print) --- */
        @media print {
            @page {
                size: auto;   /* è®“ç€è¦½å™¨ä¾æ“šå…§å®¹è‡ªå‹•åˆ¤æ–·ï¼Œæˆ–ç”± CSS è¦†è“‹ */
                margin: 5mm;
            }

            body {
                background-color: white !important;
                -webkit-print-color-adjust: exact !important; /* å¼·åˆ¶åˆ—å°èƒŒæ™¯è‰² */
                print-color-adjust: exact !important;
                font-size: 10pt;
            }

            /* éš±è—ç¶²é ä»‹é¢å…ƒç´  */
            .no-print, .modal {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }

            /* ç§»é™¤è£é£¾æ•ˆæœä»¥ç¯€çœå¢¨æ°´ä¸¦æ¸…æ™°åŒ– */
            .shadow, .shadow-md, .shadow-lg, .border-l-4 {
                box-shadow: none !important;
                border: none !important;
            }
            .rounded-lg {
                border-radius: 0 !important;
            }
            .bg-gray-100 {
                background-color: white !important;
            }

            /* --- æ¨¡å¼ A: æœˆå ±è¡¨ (è¡¨æ ¼) --- */
            body.print-mode-table .chart-section { display: none !important; }
            body.print-mode-table .table-section { 
                display: block !important; 
                width: 100%; 
            }
            body.print-mode-table table th, 
            body.print-mode-table table td {
                border: 1px solid #000 !important; /* åˆ—å°æ™‚å¼·åˆ¶é»‘è‰²é‚Šæ¡† */
            }

            /* --- æ¨¡å¼ B: è¶¨å‹¢åœ– (åœ–è¡¨) --- */
            body.print-mode-chart .table-section { display: none !important; }
            body.print-mode-chart .chart-section { 
                display: block !important; 
                width: 100% !important; 
                height: 95vh !important; /* ä½”æ»¿æ•´é  */
                page-break-inside: avoid;
            }
            /* å¼·åˆ¶è¨­å®šåœ–è¡¨å®¹å™¨å¤§å°ï¼Œå°æ‡‰ A4 æ©«å‘ */
            body.print-mode-chart #chartContainer { 
                height: 160mm !important; 
                width: 260mm !important;
            }
        }
        
        .print-only { display: none; }
    </style>
    
    <!-- ç”¨æ–¼å‹•æ…‹æ’å…¥ @page è¦å‰‡ -->
    <style id="page-style"></style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

    <!-- é ‚éƒ¨å°èˆªåˆ— (æ“ä½œå€) -->
    <div class="bg-teal-700 text-white p-4 shadow-md no-print sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center flex-wrap gap-3">
            <h1 class="text-xl font-bold flex items-center">
                <i class="fa-solid fa-temperature-half mr-2"></i>
                ç–«è‹—å†°ç®±æº«åº¦ç›£æ§ç³»çµ±
                <span class="text-xs bg-teal-800 px-2 py-1 rounded ml-2 font-normal text-teal-200 border border-teal-600">Github Pages ç‰ˆ</span>
            </h1>
            
            <div class="flex gap-2 text-sm flex-wrap">
                <!-- å‚™ä»½å€ -->
                <div class="bg-teal-800 p-1 rounded flex gap-1 border border-teal-600">
                    <button onclick="exportData()" class="bg-teal-600 hover:bg-teal-500 px-3 py-1.5 rounded transition flex items-center gap-1" title="ä¸‹è¼‰ JSON å‚™ä»½">
                        <i class="fa-solid fa-download"></i> <span class="hidden sm:inline">åŒ¯å‡º</span>
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="bg-teal-600 hover:bg-teal-500 px-3 py-1.5 rounded transition flex items-center gap-1" title="é‚„åŸ JSON å‚™ä»½">
                        <i class="fa-solid fa-upload"></i> <span class="hidden sm:inline">åŒ¯å…¥</span>
                    </button>
                    <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(this)">
                </div>

                <!-- å„²å­˜èˆ‡åˆ—å° -->
                <button onclick="saveData(true)" class="bg-blue-600 hover:bg-blue-500 px-4 py-1.5 rounded transition shadow border border-blue-400 font-bold flex items-center gap-1">
                    <i class="fa-solid fa-floppy-disk"></i> æš«å­˜
                </button>
                <button onclick="showPrintModal()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded transition shadow border border-indigo-400 font-bold flex items-center gap-1">
                    <i class="fa-solid fa-print"></i> åˆ—å°
                </button>
                <button onclick="clearData()" class="bg-red-600 hover:bg-red-500 px-4 py-1.5 rounded transition shadow border border-red-400 font-bold flex items-center gap-1">
                    <i class="fa-solid fa-trash-can"></i> æ¸…é™¤
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 max-w-7xl">
        
        <!-- 1. é¸æ“‡æœˆä»½èˆ‡æ—¥æœŸ -->
        <div class="bg-white p-6 rounded-lg shadow mb-6 no-print border-l-4 border-teal-500">
            <div class="flex flex-wrap items-end gap-6">
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-600"><i class="fa-regular fa-calendar mr-1"></i>1. é¸æ“‡æœˆä»½</label>
                    <!-- é»æ“Šæ–‡å­—æ¡†å¼·åˆ¶è§¸ç™¼ showPicker -->
                    <input type="month" id="monthPicker" class="border p-2 rounded w-48 shadow-sm cursor-pointer hover:bg-gray-50 transition font-bold text-lg text-teal-700" 
                           onclick="openDatepicker(this)" onchange="changeMonth()">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 text-gray-600"><i class="fa-regular fa-clock mr-1"></i>2. é¸æ“‡æ—¥æœŸ</label>
                    <select id="dayPicker" class="border p-2 rounded w-32 shadow-sm cursor-pointer hover:bg-gray-50 transition font-bold text-lg" onchange="loadDayData()">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    </select>
                </div>
            </div>
        </div>

        <!-- 2. è¼¸å…¥å€å¡Š (AM/PM) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6 no-print">
            <!-- ä¸Šåˆ -->
            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-blue-700">â˜€ï¸ ä¸Šåˆ (AM)</h3>
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-bold">ç°½å:</label>
                        <input type="text" id="am-sig" class="border p-1 rounded w-24 text-sm bg-blue-50 focus:bg-white" placeholder="äººå“¡ç°½å" onchange="saveData(false)">
                    </div>
                </div>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600">
                            <th class="p-2 text-left">å±¤æ•¸</th>
                            <th class="p-2">æœ€é«˜ (Max)</th>
                            <th class="p-2">æœ€ä½ (Min)</th>
                            <th class="p-2">ç•¶ä¸‹ (Cur)</th>
                        </tr>
                    </thead>
                    <tbody id="am-tbody"></tbody>
                    <tfoot class="bg-blue-50 font-bold border-t-2 border-blue-100">
                        <tr>
                            <td class="p-2">æœ€çµ‚åƒè€ƒ</td>
                            <td class="p-2 text-center text-red-600 text-lg" id="am-final-max">-</td>
                            <td class="p-2 text-center text-blue-600 text-lg" id="am-final-min">-</td>
                            <td class="p-2 text-center text-green-600 text-lg" id="am-final-avg">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- ä¸‹åˆ -->
            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-orange-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-orange-700">ğŸŒ™ ä¸‹åˆ (PM)</h3>
                    <div class="flex items-center gap-2">
                        <label class="text-sm font-bold">ç°½å:</label>
                        <input type="text" id="pm-sig" class="border p-1 rounded w-24 text-sm bg-orange-50 focus:bg-white" placeholder="äººå“¡ç°½å" onchange="saveData(false)">
                    </div>
                </div>
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600">
                            <th class="p-2 text-left">å±¤æ•¸</th>
                            <th class="p-2">æœ€é«˜ (Max)</th>
                            <th class="p-2">æœ€ä½ (Min)</th>
                            <th class="p-2">ç•¶ä¸‹ (Cur)</th>
                        </tr>
                    </thead>
                    <tbody id="pm-tbody"></tbody>
                    <tfoot class="bg-orange-50 font-bold border-t-2 border-orange-100">
                        <tr>
                            <td class="p-2">æœ€çµ‚åƒè€ƒ</td>
                            <td class="p-2 text-center text-red-600 text-lg" id="pm-final-max">-</td>
                            <td class="p-2 text-center text-blue-600 text-lg" id="pm-final-min">-</td>
                            <td class="p-2 text-center text-green-600 text-lg" id="pm-final-avg">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- åˆ—å°ç”¨æ¨™é¡Œ (å¹³å¸¸éš±è—) -->
        <div class="print-only text-center mb-4">
            <h2 class="text-2xl font-bold">è—¥åŠ‘ç§‘ç–«è‹—å†°ç®±æº«åº¦ç›£æ¸¬è¨˜éŒ„è¡¨</h2>
            <p class="text-lg mt-1 font-semibold">æœˆä»½: <span id="printMonthLabel"></span></p>
            <div class="flex justify-between text-xs text-gray-600 mt-2 px-4 border-b pb-2">
                <span>æ¨™æº–ç¯„åœï¼š2Â°C ~ 8Â°C</span>
                <span>è­¦ç¤ºç·šï¼šè—è‰² 2Â°C / ç´…è‰² 8Â°C</span>
            </div>
        </div>

        <!-- 3. åœ–è¡¨å€ (Chart Section) -->
        <div class="bg-white p-4 rounded-lg shadow mb-6 break-inside-avoid border border-gray-200 chart-section">
            <h3 class="text-lg font-bold mb-2 text-gray-700 no-print">
                <i class="fa-solid fa-chart-line mr-2"></i>æº«åº¦è¶¨å‹¢åœ– (-2Â°C ~ 12Â°C)
            </h3>
            <div id="chartContainer" style="position: relative; height: 350px; width: 100%;">
                <canvas id="tempChart"></canvas>
            </div>
        </div>

        <!-- 4. æœˆå ±è¡¨ç¸½è¦½ (Table Section) -->
        <div class="bg-white p-6 rounded-lg shadow page-break border border-gray-200 table-section">
            <h3 class="text-lg font-bold mb-4 no-print" id="summaryTitle">æœˆå ±è¡¨ç¸½è¦½</h3>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300 text-sm text-center">
                    <thead>
                        <tr class="bg-gray-200">
                            <th rowspan="2" class="border border-gray-400 p-1 w-10">æ—¥æœŸ</th>
                            <th colspan="3" class="border border-gray-400 p-1 bg-blue-100">ä¸Šåˆ (AM)</th>
                            <th colspan="3" class="border border-gray-400 p-1 bg-orange-100">ä¸‹åˆ (PM)</th>
                            <th colspan="2" class="border border-gray-400 p-1 bg-gray-100">è¨˜éŒ„äººå“¡</th>
                            <th rowspan="2" class="border border-gray-400 p-1 w-20">å‚™è¨»</th>
                        </tr>
                        <tr class="bg-gray-100 font-semibold text-xs">
                            <th class="border border-gray-400 p-1 w-10">æœ€é«˜</th>
                            <th class="border border-gray-400 p-1 w-10">æœ€ä½</th>
                            <th class="border border-gray-400 p-1 w-10">ç•¶ä¸‹</th>
                            <th class="border border-gray-400 p-1 w-10">æœ€é«˜</th>
                            <th class="border border-gray-400 p-1 w-10">æœ€ä½</th>
                            <th class="border border-gray-400 p-1 w-10">ç•¶ä¸‹</th>
                            <th class="border border-gray-400 p-1 w-16">ä¸Šåˆ</th>
                            <th class="border border-gray-400 p-1 w-16">ä¸‹åˆ</th>
                        </tr>
                    </thead>
                    <tbody id="monthlySummaryBody"></tbody>
                </table>
            </div>
            
            <div class="print-only mt-6 flex justify-between px-10 text-sm font-bold">
                <div>ç®¡ç†è—¥å¸«ç°½ç« : _________________</div>
                <div>ä¸»ä»»ç°½ç« : _________________</div>
            </div>
        </div>

    </div>

    <!-- åˆ—å°é¸é … Modal -->
    <div id="printModal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4 text-gray-800">è«‹é¸æ“‡åˆ—å°æ¨¡å¼</h2>
            <div class="flex flex-col gap-3">
                <button onclick="printReport('table', this)" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-4 rounded-lg flex items-center justify-center gap-3 shadow transition hover:scale-105">
                    <i class="fa-solid fa-table text-xl w-8"></i>
                    <div class="text-left flex-1">
                        <div class="font-bold text-lg">æœˆå ±è¡¨ç¸½è¦½</div>
                        <div class="text-xs opacity-80">A4 ç›´å¼ (Portrait)</div>
                    </div>
                </button>
                <button onclick="printReport('chart', this)" class="bg-teal-600 hover:bg-teal-500 text-white px-4 py-4 rounded-lg flex items-center justify-center gap-3 shadow transition hover:scale-105">
                    <i class="fa-solid fa-chart-line text-xl w-8"></i>
                    <div class="text-left flex-1">
                        <div class="font-bold text-lg">æº«åº¦è¶¨å‹¢åœ–</div>
                        <div class="text-xs opacity-80">A4 æ©«å¼ (Landscape)</div>
                    </div>
                </button>
            </div>
            <button onclick="closePrintModal()" class="mt-6 text-gray-500 hover:text-gray-800 underline text-sm">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- é‚è¼¯ç¨‹å¼ç¢¼ -->
    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let currentYear, currentMonth;
        let chartInstance = null;
        const storageKey = "vaccine_fridge_data_universal"; 

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                migrateOldData(); // é·ç§»èˆŠè³‡æ–™
                
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                
                const monthPicker = document.getElementById('monthPicker');
                if(monthPicker) {
                    monthPicker.value = `${year}-${month}`;
                }
                
                initInputTables();
                changeMonth();
            } catch (e) {
                console.error("Init Error:", e);
                alert("ç³»çµ±åˆå§‹åŒ–éŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
            }
        });

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ ---

        // 1. é–‹å•Ÿæ—¥æœŸé¸æ“‡å™¨ (ç›¸å®¹æ€§è™•ç†)
        function openDatepicker(el) {
            try {
                if(typeof el.showPicker === 'function') {
                    el.showPicker();
                }
            } catch(e) {
                // å¿½ç•¥ä¸æ”¯æ´çš„ç€è¦½å™¨éŒ¯èª¤
            }
        }

        // 2. åˆ—å°é‚è¼¯ (ä½¿ç”¨ requestAnimationFrame è§£æ±ºä¸åæ‡‰å•é¡Œ)
        function showPrintModal() { 
            document.getElementById('printModal').style.display = "flex"; 
        }
        
        function closePrintModal() { 
            document.getElementById('printModal').style.display = "none"; 
        }

        function printReport(type, btnElement) {
            // è¦–è¦ºå›é¥‹
            const originalText = btnElement.innerHTML;
            btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> è™•ç†ä¸­...';
            
            // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿ UI æ›´æ–°å®Œæˆ
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    try {
                        closePrintModal();
                        btnElement.innerHTML = originalText;

                        const body = document.body;
                        const style = document.getElementById('page-style');
                        
                        // æ¸…é™¤èˆŠç‹€æ…‹
                        body.classList.remove('print-mode-table', 'print-mode-chart');

                        if (type === 'table') {
                            body.classList.add('print-mode-table');
                            style.innerHTML = '@page { size: portrait; margin: 10mm; }';
                            window.print();
                        } 
                        else if (type === 'chart') {
                            body.classList.add('print-mode-chart');
                            style.innerHTML = '@page { size: landscape; margin: 5mm; }';
                            
                            // é‡æ–°èª¿æ•´åœ–è¡¨å¤§å°
                            if (chartInstance) {
                                chartInstance.resize();
                            }
                            // å†æ¬¡ä½¿ç”¨ requestAnimationFrame ç¢ºä¿åœ–è¡¨é‡ç¹ª
                            requestAnimationFrame(() => {
                                window.print();
                            });
                        }
                    } catch (e) {
                        alert("åˆ—å°å•Ÿå‹•å¤±æ•—ï¼Œè«‹å˜—è©¦æ‰‹å‹•æŒ‰ Ctrl+P æˆ– Command+Pã€‚");
                        btnElement.innerHTML = originalText;
                    }
                });
            });
        }

        // 3. è³‡æ–™é·ç§»èˆ‡åˆå§‹åŒ–
        function migrateOldData() {
            if (!localStorage.getItem(storageKey)) {
                const v3Data = localStorage.getItem("vaccine_fridge_data_v3");
                const v2Data = localStorage.getItem("vaccine_fridge_data_v2");
                if (v3Data) localStorage.setItem(storageKey, v3Data);
                else if (v2Data) localStorage.setItem(storageKey, v2Data);
            }
        }

        function initInputTables() {
            const layers = 5;
            const amBody = document.getElementById('am-tbody');
            const pmBody = document.getElementById('pm-tbody');
            let amHtml = '', pmHtml = '';
            for (let i = 1; i <= layers; i++) {
                amHtml += `
                    <tr>
                        <td class="p-2 font-semibold text-gray-700">ç¬¬ ${i} å±¤</td>
                        <td class="p-1"><input type="number" step="0.1" class="am-max bg-gray-50 focus:bg-white transition" data-layer="${i}" onchange="calculateDailySummary('am')"></td>
                        <td class="p-1"><input type="number" step="0.1" class="am-min bg-gray-50 focus:bg-white transition" data-layer="${i}" onchange="calculateDailySummary('am')"></td>
                        <td class="p-1"><input type="number" step="0.1" class="am-cur bg-gray-50 focus:bg-white transition" data-layer="${i}" onchange="calculateDailySummary('am')"></td>
                    </tr>`;
                pmHtml += `
                    <tr>
                        <td class="p-2 font-semibold text-gray-700">ç¬¬ ${i} å±¤</td>
                        <td class="p-1"><input type="number" step="0.1" class="pm-max bg-gray-50 focus:bg-white transition" data-layer="${i}" onchange="calculateDailySummary('pm')"></td>
                        <td class="p-1"><input type="number" step="0.1" class="pm-min bg-gray-50 focus:bg-white transition" data-layer="${i}" onchange="calculateDailySummary('pm')"></td>
                        <td class="p-1"><input type="number" step="0.1" class="pm-cur bg-gray-50 focus:bg-white transition" data-layer="${i}" onchange="calculateDailySummary('pm')"></td>
                    </tr>`;
            }
            amBody.innerHTML = amHtml;
            pmBody.innerHTML = pmHtml;
        }

        // 4. è³‡æ–™è¼‰å…¥èˆ‡è¨ˆç®—
        function changeMonth() {
            const picker = document.getElementById('monthPicker').value;
            if (!picker) return;
            [currentYear, currentMonth] = picker.split('-').map(Number);
            
            document.getElementById('printMonthLabel').textContent = `${currentYear} å¹´ ${currentMonth} æœˆ`;
            document.getElementById('summaryTitle').textContent = `${currentYear} å¹´ ${currentMonth} æœˆ  æœˆå ±è¡¨ç¸½è¦½`;

            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const dayPicker = document.getElementById('dayPicker');
            dayPicker.innerHTML = '';
            
            const today = new Date();
            let defaultDay = 1;
            if(today.getFullYear() === currentYear && (today.getMonth()+1) === currentMonth) {
                defaultDay = today.getDate();
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = `${i} æ—¥`;
                if(i === defaultDay) option.selected = true;
                dayPicker.appendChild(option);
            }
            loadDayData(); 
            updateMonthlyReport(); 
            updateChart(); 
        }

        function loadDayData() {
            const day = document.getElementById('dayPicker').value;
            const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
            
            document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
            document.getElementById('am-sig').value = '';
            document.getElementById('pm-sig').value = '';
            
            if (fullData[monthKey] && fullData[monthKey][day]) {
                const data = fullData[monthKey][day];
                if (data.am && data.am.layers) {
                    data.am.layers.forEach(layer => {
                        const row = document.querySelector(`.am-max[data-layer="${layer.id}"]`)?.closest('tr');
                        if(row) {
                            row.querySelector('.am-max').value = layer.max;
                            row.querySelector('.am-min').value = layer.min;
                            row.querySelector('.am-cur').value = layer.cur;
                        }
                    });
                    document.getElementById('am-sig').value = data.am.sig || '';
                }
                if (data.pm && data.pm.layers) {
                    data.pm.layers.forEach(layer => {
                        const row = document.querySelector(`.pm-max[data-layer="${layer.id}"]`)?.closest('tr');
                        if(row) {
                            row.querySelector('.pm-max').value = layer.max;
                            row.querySelector('.pm-min').value = layer.min;
                            row.querySelector('.pm-cur').value = layer.cur;
                        }
                    });
                    document.getElementById('pm-sig').value = data.pm.sig || '';
                }
            }
            calculateDailySummary('am', false);
            calculateDailySummary('pm', false);
        }

        function calculateDailySummary(period, autoSave = true) {
            const maxInputs = Array.from(document.querySelectorAll(`.${period}-max`));
            const minInputs = Array.from(document.querySelectorAll(`.${period}-min`));
            const curInputs = Array.from(document.querySelectorAll(`.${period}-cur`));
            const maxVals = maxInputs.map(i => parseFloat(i.value)).filter(v => !isNaN(v));
            const minVals = minInputs.map(i => parseFloat(i.value)).filter(v => !isNaN(v));
            const curVals = curInputs.map(i => parseFloat(i.value)).filter(v => !isNaN(v));

            let finalMax = maxVals.length ? Math.max(...maxVals) : '-';
            let finalMin = minVals.length ? Math.min(...minVals) : '-';
            let finalAvg = curVals.length ? (curVals.reduce((a, b) => a + b, 0) / curVals.length).toFixed(1) : '-';

            document.getElementById(`${period}-final-max`).textContent = finalMax;
            document.getElementById(`${period}-final-min`).textContent = finalMin;
            document.getElementById(`${period}-final-avg`).textContent = finalAvg;

            if (autoSave) saveData(false);
        }

        function saveData(showFeedback = false) {
            try {
                const day = document.getElementById('dayPicker').value;
                const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                
                const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
                if (!fullData[monthKey]) fullData[monthKey] = {};

                const dailyData = {
                    am: { ...getLayerData('am'), sig: document.getElementById('am-sig').value },
                    pm: { ...getLayerData('pm'), sig: document.getElementById('pm-sig').value },
                    summary: { am: getSummaryData('am'), pm: getSummaryData('pm') }
                };

                fullData[monthKey][day] = dailyData;
                localStorage.setItem(storageKey, JSON.stringify(fullData));
                
                updateMonthlyReport();
                updateChart();

                if (showFeedback) alert(`âœ… å„²å­˜æˆåŠŸï¼\næ—¥æœŸï¼š${currentYear}/${currentMonth}/${day}`);
            } catch (error) {
                alert("âŒ å„²å­˜å¤±æ•— (LocalStorage Error)ã€‚");
            }
        }

        function getLayerData(period) {
            const layers = [];
            for(let i=1; i<=5; i++) {
                const row = document.querySelector(`.${period}-max[data-layer="${i}"]`).closest('tr');
                layers.push({
                    id: i,
                    max: row.querySelector(`.${period}-max`).value,
                    min: row.querySelector(`.${period}-min`).value,
                    cur: row.querySelector(`.${period}-cur`).value
                });
            }
            return { layers };
        }

        function getSummaryData(period) {
            const maxEl = document.getElementById(`${period}-final-max`).textContent;
            const minEl = document.getElementById(`${period}-final-min`).textContent;
            const avgEl = document.getElementById(`${period}-final-avg`).textContent;
            return {
                max: maxEl !== '-' ? parseFloat(maxEl) : null,
                min: minEl !== '-' ? parseFloat(minEl) : null,
                cur: avgEl !== '-' ? parseFloat(avgEl) : null
            };
        }

        // 5. åŒ¯å…¥åŒ¯å‡º
        function exportData() {
            const data = localStorage.getItem(storageKey);
            if (!data) { alert("ç›®å‰ç„¡è³‡æ–™å¯åŒ¯å‡ºï¼"); return; }
            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `ç–«è‹—æº«åº¦å‚™ä»½_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (typeof json === 'object') {
                        if(confirm('æ³¨æ„ï¼šåŒ¯å…¥å°‡æœƒè¦†è“‹æ‚¨ç›®å‰çš„è³‡æ–™ï¼Œç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) {
                            localStorage.setItem(storageKey, JSON.stringify(json));
                            alert("åŒ¯å…¥æˆåŠŸï¼ç³»çµ±å°‡é‡æ–°æ•´ç†ã€‚");
                            location.reload();
                        }
                    } else alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                } catch (err) { alert("æª”æ¡ˆè§£æå¤±æ•—"); }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        function clearData() {
            if(confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡åˆªé™¤æœ¬æœˆä»½çš„æ‰€æœ‰è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼\nå»ºè­°æ‚¨å…ˆåŸ·è¡Œã€ŒåŒ¯å‡ºã€å‚™ä»½ã€‚\n\nç¢ºå®šè¦æ¸…é™¤å—ï¼Ÿ')) {
                const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
                const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
                if (fullData[monthKey]) {
                    delete fullData[monthKey];
                    localStorage.setItem(storageKey, JSON.stringify(fullData));
                    loadDayData();
                    updateMonthlyReport();
                    updateChart();
                    alert('å·²æ¸…é™¤æœ¬æœˆè³‡æ–™ã€‚');
                }
            }
        }

        // 6. åœ–è¡¨èˆ‡å ±è¡¨æ›´æ–°
        function updateMonthlyReport() {
            const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
            const monthData = fullData[monthKey] || {};
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const tbody = document.getElementById('monthlySummaryBody');
            tbody.innerHTML = '';

            for (let i = 1; i <= daysInMonth; i++) {
                const dayData = monthData[i] || { summary: { am: {}, pm: {} }, am: {}, pm: {} };
                const am = dayData.summary?.am || {};
                const pm = dayData.summary?.pm || {};
                const amSig = dayData.am?.sig || '';
                const pmSig = dayData.pm?.sig || '';

                const dateObj = new Date(currentYear, currentMonth - 1, i);
                const isWeekend = (dateObj.getDay() === 0 || dateObj.getDay() === 6);

                const row = `
                    <tr class="${isWeekend ? 'bg-gray-100' : 'bg-white'} border-b border-gray-300">
                        <td class="border-r border-gray-300 p-1 font-bold">${i}</td>
                        <td class="border-r border-gray-300 p-1 ${getColor(am.max)}">${formatVal(am.max)}</td>
                        <td class="border-r border-gray-300 p-1 ${getColor(am.min)}">${formatVal(am.min)}</td>
                        <td class="border-r border-gray-300 p-1">${formatVal(am.cur)}</td>
                        <td class="border-r border-gray-300 p-1 ${getColor(pm.max)}">${formatVal(pm.max)}</td>
                        <td class="border-r border-gray-300 p-1 ${getColor(pm.min)}">${formatVal(pm.min)}</td>
                        <td class="border-r border-gray-300 p-1">${formatVal(pm.cur)}</td>
                        <td class="border-r border-gray-300 p-1 text-xs truncate max-w-[60px]">${amSig}</td>
                        <td class="border-r border-gray-300 p-1 text-xs truncate max-w-[60px]">${pmSig}</td>
                        <td class="border-r border-gray-300 p-1"></td>
                    </tr>`;
                tbody.innerHTML += row;
            }
        }

        function formatVal(val) { return (val === null || val === undefined) ? '' : val; }
        function getColor(val) {
            if (val === null || val === undefined) return '';
            if (val > 8) return 'text-red-600 font-bold';
            if (val < 2) return 'text-blue-600 font-bold';
            return '';
        }

        function updateChart() {
            const ctx = document.getElementById('tempChart');
            if(!ctx || typeof Chart === 'undefined') return;

            const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
            const fullData = JSON.parse(localStorage.getItem(storageKey)) || {};
            const monthData = fullData[monthKey] || {};
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();

            const labels = [];
            const dataMax = [], dataMin = [], dataCur = [];

            for (let i = 1; i <= daysInMonth; i++) {
                labels.push(`${i}æ—¥ AM`, `${i}æ—¥ PM`);
                const d = monthData[i] || { summary: { am: {}, pm: {} } };
                const am = d.summary?.am || {};
                const pm = d.summary?.pm || {};
                dataMax.push(am.max ?? null, pm.max ?? null);
                dataMin.push(am.min ?? null, pm.min ?? null);
                dataCur.push(am.cur ?? null, pm.cur ?? null);
            }

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'æœ€é«˜æº«', data: dataMax, borderColor: '#ef4444', backgroundColor: '#ef444410', borderWidth: 1.5, tension: 0.1, pointRadius: 2, spanGaps: true },
                        { label: 'æœ€ä½æº«', data: dataMin, borderColor: '#3b82f6', backgroundColor: '#3b82f610', borderWidth: 1.5, tension: 0.1, pointRadius: 2, spanGaps: true },
                        { label: 'ç•¶ä¸‹æº«', data: dataCur, borderColor: '#10b981', backgroundColor: '#10b98110', borderWidth: 1.5, tension: 0.1, pointRadius: 2, spanGaps: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { min: -2, max: 12, title: { display: true, text: 'æº«åº¦ (Â°C)' } },
                        x: { ticks: { autoSkip: false, maxRotation: 90, minRotation: 90, font: { size: 10 } } }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                line1: { type: 'line', yMin: 2, yMax: 2, borderColor: 'blue', borderWidth: 2, borderDash: [6, 6], label: { content: '2Â°C', display: true, backgroundColor: 'blue', color: 'white', font: {size: 10} } },
                                line2: { type: 'line', yMin: 8, yMax: 8, borderColor: 'red', borderWidth: 2, borderDash: [6, 6], label: { content: '8Â°C', display: true, backgroundColor: 'red', color: 'white', font: {size: 10} } }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>